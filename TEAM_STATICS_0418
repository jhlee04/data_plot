Sub 분석_결과DB_최종()

    Dim wsInfo As Worksheet, wsData As Worksheet, wsOut As Worksheet
    Set wsInfo = Worksheets("답변정보")
    Set wsData = Worksheets("응답DB")

    ' 결과 시트 초기화
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets("결과DB").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    Set wsOut = Worksheets.Add
    wsOut.Name = "결과DB"

    Dim headerRow As Long: headerRow = 1
    Dim lastInfoRow As Long, lastDataRow As Long
    lastInfoRow = wsInfo.Cells(wsInfo.Rows.Count, "A").End(xlUp).Row
    lastDataRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row

    ' 팀 정보 수집
    Dim teamDict As Object: Set teamDict = CreateObject("Scripting.Dictionary")
    Dim i As Long
    For i = 2 To lastDataRow
        Dim key As String
        key = wsData.Cells(i, "C").Value & "||" & wsData.Cells(i, "D").Value
        If Not teamDict.exists(key) Then teamDict.Add key, New Collection
        teamDict(key).Add i
    Next i

    ' 문항 분류
    Dim scoreCols As Collection: Set scoreCols = New Collection
    Dim choiceGroups As Object: Set choiceGroups = CreateObject("Scripting.Dictionary")

    For i = 2 To lastInfoRow
        Dim colName As String, qType As String
        colName = wsInfo.Cells(i, "A").Value
        qType = wsInfo.Cells(i, "C").Value

        If qType = "점수형" Then
            scoreCols.Add colName
        ElseIf qType = "선택형" Then
            Dim prefix As String
            If InStr(colName, "_") > 0 Then
                prefix = Split(colName, "_")(0)
            Else
                prefix = colName
            End If
            If Not choiceGroups.exists(prefix) Then
                choiceGroups.Add prefix, New Collection
            End If
            choiceGroups(prefix).Add colName
        End If
    Next i

    ' 결과 헤더 구성
    wsOut.Cells(1, 1).Value = "부서"
    wsOut.Cells(1, 2).Value = "팀"
    Dim colMap As Object: Set colMap = CreateObject("Scripting.Dictionary")
    Dim outCol As Long: outCol = 3

    Dim colName As Variant
    For Each colName In scoreCols
        wsOut.Cells(1, outCol).Value = colName & "_평균"
        colMap.Add colName & "_평균", outCol
        outCol = outCol + 1
    Next

    Dim gKey As Variant
    For Each gKey In choiceGroups.Keys
        Dim k As Long
        For k = 1 To 3
            wsOut.Cells(1, outCol).Value = gKey & "_Top" & k
            colMap.Add gKey & "_Top" & k, outCol
            outCol = outCol + 1
            wsOut.Cells(1, outCol).Value = gKey & "_Top" & k & "_카운트"
            colMap.Add gKey & "_Top" & k & "_카운트", outCol
            outCol = outCol + 1
        Next k
    Next

    ' 결과 계산 시작
    Dim rowOut As Long: rowOut = 2
    Dim tKey As Variant
    For Each tKey In teamDict.Keys
        Dim 부서 As String: 부서 = Split(tKey, "||")(0)
        Dim 팀 As String: 팀 = Split(tKey, "||")(1)
        wsOut.Cells(rowOut, 1).Value = 부서
        wsOut.Cells(rowOut, 2).Value = 팀

        Dim rows As Collection: Set rows = teamDict(tKey)

        ' 점수형 평균 계산
        For Each colName In scoreCols
            Dim colIdx As Long
            colIdx = wsData.Rows(headerRow).Find(What:=colName, LookIn:=xlValues, LookAt:=xlWhole).Column
            Dim total As Double: total = 0
            Dim cnt As Long: cnt = 0
            Dim r As Variant
            For Each r In rows
                If IsNumeric(wsData.Cells(r, colIdx).Value) Then
                    total = total + wsData.Cells(r, colIdx).Value
                    cnt = cnt + 1
                End If
            Next
            If cnt > 0 Then
                wsOut.Cells(rowOut, colMap(colName & "_평균")).Value = Round(total / cnt, 2)
            End If
        Next

        ' 선택형 → 항목별 count 후 Top3 추출
        For Each gKey In choiceGroups.Keys
            Dim voteMap As Object: Set voteMap = CreateObject("Scripting.Dictionary")
            For Each colName In choiceGroups(gKey)
                Dim colIdx As Long
                colIdx = wsData.Rows(headerRow).Find(What:=colName, LookIn:=xlValues, LookAt:=xlWhole).Column
                Dim optionLabel As String
                If InStr(colName, "_") > 0 Then
                    optionLabel = Mid(colName, InStr(colName, "_") + 1)
                Else
                    optionLabel = colName
                End If
                Dim count As Long: count = 0
                For Each r In rows
                    If wsData.Cells(r, colIdx).Value = 1 Then count = count + 1
                Next
                voteMap(optionLabel) = count
            Next

            ' 정렬된 Top 3
            Dim keyArr As Variant: keyArr = voteMap.Keys
            Dim a, b, tmp As Variant
            For a = 0 To voteMap.Count - 2
                For b = a + 1 To voteMap.Count - 1
                    If voteMap(keyArr(a)) < voteMap(keyArr(b)) Then
                        tmp = keyArr(a)
                        keyArr(a) = keyArr(b)
                        keyArr(b) = tmp
                    End If
                Next
            Next

            Dim t As Long
            For t = 0 To WorksheetFunction.Min(2, voteMap.Count - 1)
                wsOut.Cells(rowOut, colMap(gKey & "_Top" & (t + 1))).Value = keyArr(t)
                wsOut.Cells(rowOut, colMap(gKey & "_Top" & (t + 1) & "_카운트")).Value = voteMap(keyArr(t))
            Next
        Next

        rowOut = rowOut + 1
    Next

    MsgBox "'결과DB' 시트가 생성되었습니다!", vbInformation

End Sub
