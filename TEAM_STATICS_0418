Sub 분석_결과DB_오류없는최종()

    Dim wsInfo As Worksheet, wsData As Worksheet, wsOut As Worksheet
    Set wsInfo = Worksheets("답변정보")
    Set wsData = Worksheets("응답DB")

    ' 결과 시트 초기화
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets("결과DB").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    Set wsOut = Worksheets.Add
    wsOut.Name = "결과DB"

    Dim headerRow As Long: headerRow = 1
    Dim lastInfoRow As Long, lastDataRow As Long
    lastInfoRow = wsInfo.Cells(wsInfo.Rows.Count, "A").End(xlUp).Row
    lastDataRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row

    ' 팀별 그룹핑
    Dim teamDict As Object: Set teamDict = CreateObject("Scripting.Dictionary")
    Dim rowIdx As Long
    For rowIdx = 2 To lastDataRow
        Dim teamKey As String
        teamKey = wsData.Cells(rowIdx, "C").Value & "||" & wsData.Cells(rowIdx, "D").Value
        If Not teamDict.exists(teamKey) Then teamDict.Add teamKey, New Collection
        teamDict(teamKey).Add rowIdx
    Next rowIdx

    ' 문항 분류 및 그룹화
    Dim scoreCols As Collection: Set scoreCols = New Collection
    Dim choiceGroups As Object: Set choiceGroups = CreateObject("Scripting.Dictionary")

    Dim infoRow As Long
    For infoRow = 2 To lastInfoRow
        Dim rawColName As String, qType As String
        rawColName = wsInfo.Cells(infoRow, "A").Value
        qType = wsInfo.Cells(infoRow, "C").Value

        If qType = "점수형" Then
            scoreCols.Add rawColName
        ElseIf qType = "선택형" Then
            Dim prefixName As String
            If InStr(rawColName, "_") > 0 Then
                prefixName = Split(rawColName, "_")(0)
            Else
                prefixName = rawColName
            End If
            If Not choiceGroups.exists(prefixName) Then
                choiceGroups.Add prefixName, New Collection
            End If
            choiceGroups(prefixName).Add rawColName
        End If
    Next infoRow

    ' 결과 헤더 구성
    wsOut.Cells(1, 1).Value = "부서"
    wsOut.Cells(1, 2).Value = "팀"
    Dim colMap As Object: Set colMap = CreateObject("Scripting.Dictionary")
    Dim outCol As Long: outCol = 3

    Dim scoreCol As Variant
    For Each scoreCol In scoreCols
        wsOut.Cells(1, outCol).Value = scoreCol & "_평균"
        colMap.Add scoreCol & "_평균", outCol
        outCol = outCol + 1
    Next scoreCol

    Dim groupKey As Variant
    For Each groupKey In choiceGroups.Keys
        Dim t As Long
        For t = 1 To 3
            wsOut.Cells(1, outCol).Value = groupKey & "_Top" & t
            colMap.Add groupKey & "_Top" & t, outCol
            outCol = outCol + 1
            wsOut.Cells(1, outCol).Value = groupKey & "_Top" & t & "_카운트"
            colMap.Add groupKey & "_Top" & t & "_카운트", outCol
            outCol = outCol + 1
        Next t
    Next groupKey

    ' 결과 계산
    Dim resultRow As Long: resultRow = 2
    Dim teamKey As Variant
    For Each teamKey In teamDict.Keys
        Dim 부서 As String: 부서 = Split(teamKey, "||")(0)
        Dim 팀 As String: 팀 = Split(teamKey, "||")(1)
        wsOut.Cells(resultRow, 1).Value = 부서
        wsOut.Cells(resultRow, 2).Value = 팀

        Dim rows As Collection: Set rows = teamDict(teamKey)

        ' 점수형 평균 계산
        For Each scoreCol In scoreCols
            Dim colIdx As Long
            colIdx = wsData.Rows(headerRow).Find(What:=scoreCol, LookIn:=xlValues, LookAt:=xlWhole).Column
            Dim total As Double: total = 0
            Dim cnt As Long: cnt = 0
            Dim r As Variant
            For Each r In rows
                If IsNumeric(wsData.Cells(r, colIdx).Value) Then
                    total = total + wsData.Cells(r, colIdx).Value
                    cnt = cnt + 1
                End If
            Next r
            If cnt > 0 Then
                wsOut.Cells(resultRow, colMap(scoreCol & "_평균")).Value = Round(total / cnt, 2)
            End If
        Next scoreCol

        ' 선택형 Top3 계산
        For Each groupKey In choiceGroups.Keys
            Dim voteMap As Object: Set voteMap = CreateObject("Scripting.Dictionary")
            Dim choiceCol As Variant
            For Each choiceCol In choiceGroups(groupKey)
                Dim colIdx As Long
                colIdx = wsData.Rows(headerRow).Find(What:=choiceCol, LookIn:=xlValues, LookAt:=xlWhole).Column
                Dim label As String
                If InStr(choiceCol, "_") > 0 Then
                    label = Mid(choiceCol, InStr(choiceCol, "_") + 1)
                Else
                    label = choiceCol
                End If
                Dim count As Long: count = 0
                For Each r In rows
                    If wsData.Cells(r, colIdx).Value = 1 Then count = count + 1
                Next r
                voteMap(label) = count
            Next choiceCol

            ' 정렬 후 Top 3 추출
            Dim topKeys As Variant: topKeys = voteMap.Keys
            Dim a As Long, b As Long, tmp As Variant
            For a = 0 To voteMap.Count - 2
                For b = a + 1 To voteMap.Count - 1
                    If voteMap(topKeys(a)) < voteMap(topKeys(b)) Then
                        tmp = topKeys(a)
                        topKeys(a) = topKeys(b)
                        topKeys(b) = tmp
                    End If
                Next b
            Next a

            Dim t As Long
            For t = 0 To WorksheetFunction.Min(2, voteMap.Count - 1)
                wsOut.Cells(resultRow, colMap(groupKey & "_Top" & (t + 1))).Value = topKeys(t)
                wsOut.Cells(resultRow, colMap(groupKey & "_Top" & (t + 1) & "_카운트")).Value = voteMap(topKeys(t))
            Next t
        Next groupKey

        resultRow = resultRow + 1
    Next teamKey

    MsgBox "'결과DB' 시트가 생성되었습니다!", vbInformation

End Sub
